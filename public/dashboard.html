<!DOCTYPE html>
<html>
<head>
  <title>Ashwin Remote - Dashboard</title>
</head>
<body>
  <h2>Ashwin Remote Dashboard</h2>

  <p id="user"></p>

  <button id="shareBtn">Share My Screen</button>
  <button id="viewBtn">View Friend Screen</button>

  <video id="remoteVideo" autoplay playsinline style="width:80%; border:1px solid black;"></video>

  <script src="/socket.io/socket.io.js"></script>
 <script>
  const user = localStorage.getItem("user");
  if (!user) {
    window.location.href = "login.html";
  }
  document.getElementById("user").innerText = "Logged in as: " + user;

  const socket = io();
  const shareBtn = document.getElementById("shareBtn");
  const viewBtn = document.getElementById("viewBtn");
  const remoteVideo = document.getElementById("remoteVideo");

  let peer;

  socket.on("connect", () => {
    console.log("Connected to server");
  });

  // SHARE MY SCREEN
  shareBtn.onclick = async () => {
    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: true
    });

    peer = new RTCPeerConnection();

    stream.getTracks().forEach(track => peer.addTrack(track, stream));

    peer.onicecandidate = e => {
      if (e.candidate) socket.emit("ice", e.candidate);
    };

    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);
    socket.emit("offer", offer);
  };

  // VIEW FRIEND SCREEN
  viewBtn.onclick = () => {
    peer = new RTCPeerConnection();

    peer.ontrack = e => {
      remoteVideo.srcObject = e.streams[0];
    };

    peer.onicecandidate = e => {
      if (e.candidate) socket.emit("ice", e.candidate);
    };
  };

  socket.on("offer", async offer => {
    if (!peer) return;
    await peer.setRemoteDescription(offer);
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);
    socket.emit("answer", answer);
  });

  socket.on("answer", async answer => {
    await peer.setRemoteDescription(answer);
  });

  socket.on("ice", async candidate => {
    await peer.addIceCandidate(candidate);
  });
</script>
</body>
</html>
